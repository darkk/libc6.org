Title: Проблема с медленным allocate в libguestfs.
Slug: slow-allocation-problem-with-libguestfs
Category: Администрирование
Date: 2011-10-17 19:23
Source: False

Если вы используете guestfs_fallocate64 для создания файла под виртуальную машину, то на некоторых системах вы можете заметить очень низкую производительность дискового IO в момент создания.

Скорее всего дело в том, что Вы используете файловую систему ext3 для хранения образов виртуальных машин. Ну или у Вас ядро не поддерживает системный вызов [fallocate](http://lwn.net/Articles/226710/).

Поясню почему возникает проблема:

* libguestfs [проверяет](http://git.annexia.org/?p=libguestfs.git;a=blob;f=fish/alloc.c;h=7799e4e1c5f0b34ce079934eea7d7c0a13ecdcd3;hb=HEAD#l86) наличие возможности использовать системный вызов fallocate.

    * Если такой вызов не поддерживается, то мы просто забиваем нолями нужный объём пространства.
    * Если поддерживается, то ядро говорит файловой системе - займи нужное пространство. В таком случае операция выполняется очень быстро.

В файловой системе ext2-3 поддержка fallocate не реализована. Можно использовать fallocate в файловых системах ext4, xfs, btrfs.

Надо бы ещё поисследовать то, как влияет размер inode файловой системы на производительность виртуалок.
